name: Documentation

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
      - '.readthedocs.yml'
      - '.github/workflows/docs.yml'
  pull_request:
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
      - '.readthedocs.yml'
      - '.github/workflows/docs.yml'

jobs:
  build-sphinx:
    name: Build Sphinx Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install sphinx sphinx-rtd-theme myst-parser
      
      - name: Build Sphinx documentation
        run: |
          cd docs
          make html
      
      - name: Check for broken links
        run: |
          cd docs
          make linkcheck
        continue-on-error: true
      
      - name: Upload Sphinx artifacts
        uses: actions/upload-artifact@v3
        with:
          name: sphinx-docs
          path: docs/_build/html/
  
  build-mkdocs:
    name: Build MkDocs Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mkdocs mkdocs-material mkdocs-minify-plugin mkdocs-git-revision-date-localized-plugin
      
      - name: Build MkDocs documentation
        run: mkdocs build --strict
      
      - name: Upload MkDocs artifacts
        uses: actions/upload-artifact@v3
        with:
          name: mkdocs-site
          path: site/
  
  deploy-gh-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build-mkdocs
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mkdocs mkdocs-material mkdocs-minify-plugin mkdocs-git-revision-date-localized-plugin
      
      - name: Deploy to GitHub Pages
        run: mkdocs gh-deploy --force
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  check-links:
    name: Check Documentation Links
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install linkchecker
      
      - name: Build documentation
        run: |
          pip install mkdocs mkdocs-material
          mkdocs build
      
      - name: Check links
        run: |
          linkchecker site/ --check-extern
        continue-on-error: true
  
  validate-markdown:
    name: Validate Markdown
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Lint Markdown files
        uses: nosborn/github-action-markdown-cli@v3.2.0
        with:
          files: docs/
          config_file: .markdownlint.json
        continue-on-error: true
